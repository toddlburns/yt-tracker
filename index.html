<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Artist Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%2300FFFF'/><stop offset='50%25' stop-color='%23FF69B4'/><stop offset='100%25' stop-color='%238B5CF6'/></linearGradient></defs><circle cx='50' cy='50' r='45' fill='url(%23g)'/><path d='M50 20 C30 35 30 65 50 80 C70 65 70 35 50 20' fill='%23fff' opacity='0.3'/><circle cx='35' cy='45' r='5' fill='%23fff'/><circle cx='65' cy='45' r='5' fill='%23fff'/></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, #0a1628 0%, #0d0d1a 50%, #1a0a20 100%);
            color: #E0F7FF;
            min-height: 100vh;
        }

        /* Animated wave pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 80%, rgba(0, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 105, 180, 0.05) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
            animation: shimmer 8s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Bubble animation */
        body::after {
            content: '';
            position: fixed;
            bottom: 0; left: 0; right: 0; height: 200px;
            background:
                radial-gradient(circle at 10% 90%, rgba(0, 255, 255, 0.15) 0%, transparent 8%),
                radial-gradient(circle at 30% 85%, rgba(255, 105, 180, 0.1) 0%, transparent 5%),
                radial-gradient(circle at 50% 95%, rgba(139, 92, 246, 0.12) 0%, transparent 6%),
                radial-gradient(circle at 70% 88%, rgba(0, 255, 255, 0.08) 0%, transparent 4%),
                radial-gradient(circle at 90% 92%, rgba(255, 105, 180, 0.1) 0%, transparent 7%);
            pointer-events: none;
            z-index: 0;
            animation: bubbles 4s ease-in-out infinite;
        }

        @keyframes bubbles {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Password Gate */
        #gate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        #gate h1, .app-header h1 {
            font-family: 'Righteous', cursive;
            letter-spacing: 3px;
            position: relative;
            background:
                radial-gradient(circle at 20% 50%, #00FFFF 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, #FF69B4 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, #8B5CF6 0%, transparent 50%),
                radial-gradient(circle at 30% 80%, #00CED1 0%, transparent 40%),
                radial-gradient(circle at 70% 30%, #FF1493 0%, transparent 45%),
                radial-gradient(circle at 50% 70%, #9370DB 0%, transparent 40%),
                linear-gradient(135deg, #0a1628 0%, #1a0a20 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: lavaLamp 8s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.4)) drop-shadow(0 0 40px rgba(255, 105, 180, 0.3));
        }
        #gate h1 { font-size: 2.4rem; margin-bottom: 8px; }

        @keyframes lavaLamp {
            0% {
                background-position: 0% 50%, 100% 50%, 50% 0%, 0% 100%, 100% 0%, 50% 100%, 0% 0%;
            }
            25% {
                background-position: 50% 0%, 50% 100%, 100% 50%, 100% 50%, 0% 100%, 0% 50%, 25% 25%;
            }
            50% {
                background-position: 100% 50%, 0% 50%, 50% 100%, 50% 0%, 50% 50%, 100% 0%, 50% 50%;
            }
            75% {
                background-position: 50% 100%, 50% 0%, 0% 50%, 0% 50%, 100% 0%, 50% 100%, 75% 75%;
            }
            100% {
                background-position: 0% 50%, 100% 50%, 50% 0%, 0% 100%, 100% 0%, 50% 100%, 0% 0%;
            }
        }
        #gate p { font-size: 0.9rem; color: #7DD3E8; margin-bottom: 24px; }
        #gate .input-row { display: flex; gap: 8px; }
        #gate input {
            padding: 12px 18px; font-size: 1rem;
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(0, 20, 40, 0.8);
            color: #E0F7FF;
            outline: none; width: 260px; font-family: 'Inter', sans-serif;
            backdrop-filter: blur(10px);
        }
        #gate input:focus {
            border-color: #00FFFF;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4), inset 0 0 20px rgba(0, 255, 255, 0.1);
        }
        #gate button {
            padding: 12px 24px; font-size: 1rem; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #00FFFF 0%, #FF69B4 100%);
            color: #0a1628; cursor: pointer; font-weight: 600;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
            transition: all 0.3s;
        }
        #gate button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 255, 255, 0.6);
        }
        #gate .error { color: #FF69B4; font-size: 0.85rem; margin-top: 12px; min-height: 20px; }

        /* App */
        #app { display: none; max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }

        .app-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 20px; padding-bottom: 16px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.2);
            background: linear-gradient(180deg, rgba(0, 255, 255, 0.05) 0%, transparent 100%);
            padding: 16px; margin: -20px -20px 20px -20px;
        }
        .app-header h1 { font-size: 1.8rem; letter-spacing: 2px; }
        .app-header .lock-btn {
            background: rgba(0, 20, 40, 0.6);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #7DD3E8; padding: 8px 14px;
            border-radius: 20px; cursor: pointer; font-size: 0.75rem;
            font-family: 'Inter', sans-serif; text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
        }
        .app-header .lock-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00FFFF;
            color: #00FFFF;
        }

        .subtitle { font-size: 0.8rem; color: #7DD3E8; margin-top: 6px; }

        /* Tab Navigation */
        .tab-nav {
            display: flex; gap: 0; margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.2);
        }
        .tab-btn {
            padding: 12px 24px; font-size: 0.9rem;
            background: transparent; border: none; color: #7DD3E8;
            cursor: pointer; font-family: 'Inter', sans-serif;
            font-weight: 500; position: relative;
            transition: all 0.3s;
        }
        .tab-btn:hover { color: #00FFFF; }
        .tab-btn.active { color: #00FFFF; }
        .tab-btn.active::after {
            content: '';
            position: absolute; bottom: -2px; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00FFFF 0%, #FF69B4 100%);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .tab-btn .tab-badge {
            background: linear-gradient(135deg, #FF69B4 0%, #8B5CF6 100%);
            color: #fff; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 10px; margin-left: 6px;
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Music News Tab */
        .news-filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .news-filter-btn {
            padding: 6px 14px; font-size: 0.8rem; border-radius: 20px;
            border: 1px solid rgba(0, 255, 255, 0.3); background: transparent;
            color: #7DD3E8; cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }
        .news-filter-btn:hover { border-color: #00FFFF; color: #00FFFF; }
        .news-filter-btn.active { background: rgba(0, 255, 255, 0.15); border-color: #00FFFF; color: #00FFFF; }
        .news-card {
            display: flex; gap: 14px; padding: 14px; border-radius: 10px;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            background: rgba(0, 20, 40, 0.4);
            text-decoration: none; color: inherit;
        }
        .news-card:hover {
            background: rgba(0, 255, 255, 0.08);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.15);
        }
        .news-card-body { flex: 1; min-width: 0; }
        .news-card-title {
            font-weight: 600; font-size: 0.95rem; color: #E0F7FF;
            margin-bottom: 4px; line-height: 1.3;
        }
        .news-card-meta {
            font-size: 0.75rem; color: #5a8a9a; display: flex; gap: 10px; flex-wrap: wrap;
        }
        .news-card-source {
            padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;
            display: inline-block;
        }
        .news-source-billboard { background: rgba(255, 59, 48, 0.2); color: #FF6B6B; }
        .news-source-variety { background: rgba(139, 92, 246, 0.2); color: #B794F6; }
        .news-source-rollingstone { background: rgba(255, 105, 180, 0.2); color: #FF69B4; }
        .news-card.news-highlight {
            border-left: 3px solid #00FFFF;
            background: rgba(0, 255, 255, 0.06);
        }
        .news-artist-tag {
            padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;
            background: rgba(0, 255, 255, 0.15); color: #00FFFF;
        }

        /* Progress bar */
        .progress-wrap {
            width: 100%; height: 6px;
            background: rgba(0, 20, 40, 0.6);
            border-radius: 3px; margin-bottom: 16px; overflow: hidden; display: none;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00FFFF 0%, #FF69B4 50%, #8B5CF6 100%);
            border-radius: 3px; transition: width 0.2s ease;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }

        /* Manage Channels */
        .manage-toggle {
            background: rgba(0, 20, 40, 0.6);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #00FFFF; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-size: 0.8rem; margin-bottom: 16px;
            font-family: 'Inter', sans-serif; text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        .manage-toggle:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
        .manage-section {
            display: none; margin-bottom: 24px; padding: 20px;
            background: rgba(0, 20, 40, 0.6);
            border-radius: 12px;
            border: 2px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .manage-section.open { display: block; }

        .search-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .search-row input {
            flex: 1; min-width: 200px; padding: 10px 16px; font-size: 0.9rem;
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(0, 20, 40, 0.8);
            color: #E0F7FF; outline: none; font-family: 'Inter', sans-serif;
        }
        .search-row input:focus { border-color: #00FFFF; box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); }
        .search-row select {
            padding: 10px 16px; font-size: 0.9rem;
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(0, 20, 40, 0.8);
            color: #E0F7FF;
            font-family: 'Inter', sans-serif; cursor: pointer;
        }
        .search-row button {
            padding: 10px 20px; font-size: 0.9rem; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #00FFFF 0%, #FF69B4 100%);
            color: #0a1628; cursor: pointer; font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }
        .search-row button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
        }

        .search-results { margin-bottom: 16px; }
        .search-result {
            display: flex; align-items: center; gap: 12px; padding: 10px 12px;
            border-radius: 8px; cursor: pointer; transition: background 0.15s;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }
        .search-result:hover { background: rgba(0, 255, 255, 0.1); }
        .search-result img {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
        }
        .search-result .sr-info { flex: 1; }
        .search-result .sr-name { font-size: 0.9rem; color: #E0F7FF; }
        .search-result .sr-subs { font-size: 0.75rem; color: #7DD3E8; }
        .search-result .sr-add {
            font-size: 0.8rem; color: #00FFFF; background: none;
            border: 2px solid #00FFFF;
            padding: 6px 14px; border-radius: 20px; cursor: pointer;
            font-family: 'Inter', sans-serif; font-weight: 500;
            transition: all 0.3s;
        }
        .search-result .sr-add:hover { background: #00FFFF; color: #0a1628; }

        .channel-section { margin-bottom: 16px; }
        .channel-label {
            font-size: 0.8rem; color: #FF69B4; margin-bottom: 10px;
            font-family: 'Inter', sans-serif; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 8px;
        }
        .channel-label .count {
            background: linear-gradient(135deg, #00FFFF 0%, #8B5CF6 100%);
            color: #0a1628; padding: 2px 10px;
            border-radius: 10px; font-size: 0.7rem; font-weight: 600;
        }
        .channel-pills { display: flex; flex-wrap: wrap; gap: 8px; }
        .channel-pill {
            display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px;
            background: linear-gradient(135deg, #FF69B4 0%, #8B5CF6 100%);
            border-radius: 20px; font-size: 0.8rem; color: #fff;
            border: none;
            box-shadow: 0 2px 10px rgba(255, 105, 180, 0.3);
        }
        .channel-pill.omni {
            background: linear-gradient(135deg, #00FFFF 0%, #00CED1 100%);
            color: #0a1628;
        }
        .channel-pill .remove-channel {
            background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer;
            font-size: 0.9rem; padding: 0 2px; line-height: 1;
        }
        .channel-pill .remove-channel:hover { color: #fff; }
        .channel-pill.omni .remove-channel { color: rgba(0,0,0,0.5); }
        .channel-pill.omni .remove-channel:hover { color: #0a1628; }

        /* Feed */
        .feed-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0;
            border-top: 2px solid rgba(0, 255, 255, 0.2);
            margin-bottom: 12px;
        }
        .feed-title {
            font-size: 0.85rem; color: #00FFFF;
            font-family: 'Inter', sans-serif; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        .refresh-btn {
            background: rgba(0, 20, 40, 0.6);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #7DD3E8; padding: 6px 14px;
            border-radius: 20px; cursor: pointer; font-size: 0.75rem;
            font-family: 'Inter', sans-serif; text-transform: uppercase;
            transition: all 0.3s;
        }
        .refresh-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00FFFF;
            color: #00FFFF;
        }

        .feed-empty {
            text-align: center; color: #7DD3E8; padding: 50px 0; font-size: 0.95rem;
        }

        /* Video card */
        .video-card {
            display: flex; gap: 14px; padding: 14px; border-radius: 10px;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            background: rgba(0, 20, 40, 0.4);
        }
        .video-card:hover {
            background: rgba(0, 255, 255, 0.08);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.15);
        }
        .video-card.dismissed { display: none; }

        .vc-check {
            flex-shrink: 0; width: 22px; height: 22px; margin-top: 2px;
            border: 2px solid rgba(0, 255, 255, 0.4); border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
            background: rgba(0, 20, 40, 0.6);
        }
        .vc-check:hover { border-color: #00FFFF; box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); }
        .vc-check.checked {
            border-color: #00FFFF;
            background: linear-gradient(135deg, #00FFFF 0%, #FF69B4 100%);
        }
        .vc-check.checked::after { content: '\2713'; color: #0a1628; font-size: 12px; font-weight: 700; }

        .vc-body { flex: 1; min-width: 0; }
        .vc-meta { display: flex; gap: 10px; align-items: center; margin-bottom: 4px; flex-wrap: wrap; }
        .vc-channel { font-size: 0.85rem; color: #FF69B4; font-weight: 600; }
        .vc-time { font-size: 0.75rem; color: #7DD3E8; }
        .vc-omni-tag {
            font-size: 0.65rem;
            background: linear-gradient(135deg, #00FFFF 0%, #00CED1 100%);
            color: #0a1628; padding: 2px 8px; border-radius: 10px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;
        }
        .vc-title { font-size: 0.95rem; color: #E0F7FF; margin-bottom: 4px; line-height: 1.4; }
        .vc-title.official-mv { color: #00FFFF; font-weight: 600; text-shadow: 0 0 10px rgba(0, 255, 255, 0.3); }
        .vc-info-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .vc-duration { font-size: 0.8rem; color: #7DD3E8; }
        .vc-views-inline { font-size: 0.8rem; color: #7DD3E8; }
        .vc-views-inline.popular { color: #00FFFF; text-shadow: 0 0 8px rgba(0, 255, 255, 0.3); }
        .vc-artist-match {
            font-size: 0.7rem;
            background: linear-gradient(135deg, #FF69B4 0%, #8B5CF6 100%);
            color: #fff; padding: 2px 8px; border-radius: 10px; font-weight: 500;
        }

        .vc-thumb-wrap {
            flex-shrink: 0; position: relative; width: 160px; height: 90px;
        }
        .vc-thumb {
            width: 100%; height: 100%; border-radius: 6px;
            object-fit: cover; background: rgba(0, 20, 40, 0.8);
            border: 3px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.3s;
        }
        .vc-thumb-wrap:hover .vc-thumb {
            border-color: #00FFFF;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
        }
        .vc-thumb-wrap:hover .vc-thumb-btns { opacity: 1; }
        .vc-thumb-btns {
            position: absolute; bottom: 6px; right: 6px;
            display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;
        }
        .vc-thumb-btn {
            width: 30px; height: 30px; border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4 0%, #8B5CF6 100%);
            border: 2px solid #fff; color: #fff; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 12px;
            transition: all 0.15s;
            box-shadow: 0 2px 10px rgba(255, 105, 180, 0.4);
        }
        .vc-thumb-btn:hover { transform: scale(1.1); }
        .vc-thumb-btn.yt-btn {
            background: linear-gradient(135deg, #00FFFF 0%, #00CED1 100%);
            color: #0a1628;
        }

        /* Image lightbox */
        .lightbox {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 22, 40, 0.98); z-index: 1000;
            align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(10px);
        }
        .lightbox.open { display: flex; }
        .lightbox img {
            max-width: 90vw; max-height: 90vh; border-radius: 12px;
            border: 4px solid rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 60px rgba(0, 255, 255, 0.3), 0 0 100px rgba(255, 105, 180, 0.2);
        }
        .lightbox-close {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4 0%, #8B5CF6 100%);
            border: 3px solid #fff; color: #fff;
            font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 105, 180, 0.5);
        }
        .lightbox-close:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
        }


        /* Seapunk scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #0a1628 0%, #0d0d1a 100%);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00FFFF 0%, #8B5CF6 100%);
            border-radius: 5px; border: 2px solid #0a1628;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00FFFF 0%, #FF69B4 100%);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        /* Loading spinner */
        .loading-spinner {
            display: flex; align-items: center; justify-content: center;
            padding: 40px; color: #7DD3E8;
        }
        .loading-spinner::before {
            content: '';
            width: 30px; height: 30px;
            border: 3px solid rgba(0, 255, 255, 0.2);
            border-top-color: #00FFFF;
            border-right-color: #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .no-data { text-align: center; color: #7DD3E8; padding: 40px; }

        /* Official Artist Stores Styles */
        .stores-header {
            text-align: center;
            padding: 24px 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 16px;
            border: 2px solid rgba(0, 255, 255, 0.3);
        }
        .stores-header h2 {
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #00FFFF 0%, #8B5CF6 50%, #FF69B4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .stores-header p {
            color: #7DD3E8;
            font-size: 0.9rem;
        }
        .stores-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .stores-btn {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .stores-btn.primary {
            background: linear-gradient(135deg, #00FFFF 0%, #8B5CF6 100%);
            color: #0a1628;
        }
        .stores-btn.primary:hover {
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        .stores-btn.secondary {
            background: rgba(0, 20, 40, 0.6);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: #00FFFF;
        }
        .stores-btn.secondary:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00FFFF;
        }
        .stores-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .stores-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .stores-stat {
            text-align: center;
        }
        .stores-stat .number {
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
            color: #00FFFF;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }
        .stores-stat .number.sold-out { color: #FF69B4; text-shadow: 0 0 15px rgba(255, 105, 180, 0.4); }
        .stores-stat .label {
            font-size: 0.75rem;
            color: #7DD3E8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .store-section {
            margin-bottom: 24px;
            background: rgba(0, 20, 40, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 255, 0.15);
            overflow: hidden;
        }
        .store-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(0, 255, 255, 0.05);
            border-bottom: 1px solid rgba(0, 255, 255, 0.15);
            cursor: pointer;
        }
        .store-section-header:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        .store-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #00FFFF;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .store-section-title .store-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
        }
        .store-section-count {
            font-size: 0.8rem;
            color: #FF69B4;
            background: rgba(255, 105, 180, 0.15);
            padding: 4px 12px;
            border-radius: 15px;
        }
        .store-copy-btn {
            font-size: 0.6rem;
            padding: 3px 7px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            background: rgba(0, 255, 255, 0.1);
            color: #00FFFF;
            cursor: pointer;
            transition: all 0.2s;
        }
        .store-copy-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00FFFF;
        }
        .store-copy-btn.music-btn {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.1);
            color: #A78BFA;
        }
        .store-copy-btn.music-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8B5CF6;
        }
        .store-copy-btn.merch-btn {
            border-color: rgba(245, 158, 11, 0.4);
            background: rgba(245, 158, 11, 0.1);
            color: #FBBF24;
        }
        .store-copy-btn.merch-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: #F59E0B;
        }
        .store-copy-btn.copied {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00FF88;
            color: #00FF88;
        }
        .store-copy-buttons {
            display: flex;
            gap: 4px;
        }
        .store-section-body {
            padding: 12px;
            display: none;
        }
        .store-section.open .store-section-body {
            display: block;
        }
        .store-section-header .chevron {
            color: #7DD3E8;
            transition: transform 0.3s;
        }
        .store-section.open .store-section-header .chevron {
            transform: rotate(180deg);
        }

        .sold-out-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 105, 180, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .sold-out-item:hover {
            background: rgba(255, 105, 180, 0.12);
        }
        .sold-out-item:last-child {
            margin-bottom: 0;
        }
        .sold-out-thumb {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(255, 105, 180, 0.3);
        }
        .sold-out-info {
            flex: 1;
            min-width: 0;
        }
        .sold-out-title {
            font-size: 0.9rem;
            color: #E0F7FF;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sold-out-vendor {
            font-size: 0.75rem;
            color: #7DD3E8;
        }
        .sold-out-upc {
            font-size: 0.7rem;
            color: #00FF88;
            font-family: monospace;
            background: rgba(0, 255, 136, 0.1);
            padding: 1px 6px;
            border-radius: 4px;
            margin-top: 2px;
            display: inline-block;
        }
        .sold-out-badge {
            font-size: 0.65rem;
            background: #FF69B4;
            color: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .product-type-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .product-type-badge.music {
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            color: #fff;
        }
        .product-type-badge.merch {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: #fff;
        }
        .category-group-header {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 12px;
            margin: 8px 0 6px 0;
            border-radius: 6px;
        }
        .category-group-header:first-child {
            margin-top: 0;
        }
        .category-group-header.music {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
            border-left: 3px solid #8B5CF6;
        }
        .category-group-header.merch {
            background: rgba(245, 158, 11, 0.15);
            color: #FBBF24;
            border-left: 3px solid #F59E0B;
        }
        .sold-out-link {
            color: #00FFFF;
            text-decoration: none;
            font-size: 1.1rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .sold-out-link:hover {
            background: rgba(0, 255, 255, 0.15);
        }

        .stores-progress {
            margin: 20px 0;
        }
        .stores-progress-bar {
            height: 6px;
            background: rgba(0, 20, 40, 0.6);
            border-radius: 3px;
            overflow: hidden;
        }
        .stores-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00FFFF 0%, #8B5CF6 50%, #FF69B4 100%);
            border-radius: 3px;
            transition: width 0.3s;
        }
        .stores-progress-text {
            font-size: 0.8rem;
            color: #7DD3E8;
            margin-top: 8px;
            text-align: center;
        }

        /* Individual Store Buttons Grid */
        .store-buttons-section {
            margin: 20px 0;
        }
        .store-buttons-title {
            font-size: 0.85rem;
            color: #7DD3E8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            text-align: center;
        }
        .store-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .store-btn-individual {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 2px solid rgba(0, 255, 255, 0.25);
            background: rgba(0, 20, 40, 0.6);
            color: #E0F7FF;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .store-btn-individual:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00FFFF;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.2);
        }
        .store-btn-individual:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .store-btn-individual.scanning {
            border-color: #8B5CF6;
            animation: pulse-border 1s ease-in-out infinite;
        }
        .store-btn-individual.success {
            border-color: #00FF88;
            background: rgba(0, 255, 136, 0.1);
        }
        .store-btn-individual.error {
            border-color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
        }
        .store-btn-status {
            font-size: 0.65rem;
            color: #7DD3E8;
        }
        .store-btn-individual.success .store-btn-status {
            color: #00FF88;
        }
        .store-btn-individual.error .store-btn-status {
            color: #FF6B6B;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(139, 92, 246, 0.5); }
            50% { border-color: #8B5CF6; }
        }
    </style>
</head>
<body>

<!-- Password Gate -->
<div id="gate">
    <h1 id="gate-title">Priority Artist Hub</h1>
    <p id="gate-subtitle">Enter your password to continue</p>
    <div class="input-row">
        <input type="password" id="pw-input" placeholder="Password" autocomplete="off">
        <button id="pw-btn" onclick="handlePassword()">Enter</button>
    </div>
    <div class="error" id="pw-error"></div>
</div>

<!-- Main App -->
<div id="app">
    <div class="app-header">
        <div>
            <h1>Priority Artist Hub</h1>
            <div class="subtitle" id="subtitle">Loading...</div>
        </div>
        <button class="lock-btn" onclick="logout()">Log Out</button>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('youtube')" id="tab-youtube">
            YouTube Tracker
        </button>
        <button class="tab-btn" onclick="switchTab('stores')" id="tab-stores">
            Artist Stores <span class="tab-badge" id="stores-sold-out-count" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('news')" id="tab-news">
            Music News
        </button>
    </div>

    <!-- YouTube Tab -->
    <div class="tab-content active" id="content-youtube">
        <div class="progress-wrap" id="progress-wrap">
            <div class="progress-bar" id="progress-bar" style="width:0%"></div>
        </div>

        <button class="manage-toggle" id="manage-toggle" onclick="toggleManage()">&#9830; Manage Channels</button>

        <div class="manage-section" id="manage-section">
            <div class="search-row">
                <input type="text" id="channel-search" placeholder="Search for a channel..." autocomplete="off">
                <select id="channel-type">
                    <option value="artist">Artist Channel</option>
                    <option value="omni">Omni Channel</option>
                </select>
                <button onclick="searchChannel()">Search</button>
            </div>
            <div class="search-results" id="search-results"></div>

            <div class="channel-section">
                <div class="channel-label">
                    Artist Channels <span class="count" id="artist-count">0</span>
                </div>
                <div class="channel-pills" id="artist-pills"></div>
            </div>

            <div class="channel-section">
                <div class="channel-label">
                    Omni Channels <span class="count" id="omni-count">0</span>
                    <span style="font-size:0.75rem;color:#8a7a6a;font-style:italic;margin-left:8px;">
                        (searches for artist names)
                    </span>
                </div>
                <div class="channel-pills" id="omni-pills"></div>
            </div>
        </div>

        <div class="feed-header">
            <div class="feed-title" id="feed-title">The Reel</div>
            <button class="refresh-btn" onclick="refreshFeed()">Refresh</button>
        </div>

        <div id="feed"></div>
    </div>

    <!-- Artist Stores Tab -->
    <div class="tab-content" id="content-stores">
        <div class="stores-header">
            <h2>Official Artist Stores</h2>
            <p>Track sold-out products across artist stores</p>
        </div>

        <div class="stores-progress" id="stores-progress" style="display: none;">
            <div class="stores-progress-bar">
                <div class="stores-progress-fill" id="stores-progress-fill" style="width: 0%"></div>
            </div>
            <div class="stores-progress-text" id="stores-progress-text">Scanning stores...</div>
        </div>

        <div class="store-buttons-section">
            <div class="store-buttons-title">Scan Individual Stores</div>
            <div class="store-buttons-grid" id="store-buttons-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="feed-header">
            <div class="feed-title">Sold Out Products</div>
        </div>

        <div id="stores-sold-out-list"></div>
    </div>

    <!-- Music News Tab -->
    <div class="tab-content" id="content-news">
        <div class="feed-header">
            <div class="feed-title">Music News</div>
            <button class="refresh-btn" onclick="refreshNews()">Refresh</button>
        </div>
        <div class="news-filters">
            <button class="news-filter-btn active" onclick="filterNews('all')">All</button>
            <button class="news-filter-btn" onclick="filterNews('artists')">Our Artists</button>
            <button class="news-filter-btn" onclick="filterNews('billboard')">Billboard</button>
            <button class="news-filter-btn" onclick="filterNews('variety')">Variety</button>
            <button class="news-filter-btn" onclick="filterNews('rollingstone')">Rolling Stone</button>
        </div>
        <div id="news-feed"></div>
    </div>
</div>

<!-- Image Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <img id="lightbox-img" src="" alt="Video thumbnail">
</div>

<script>
// ─── Default Channels ───────────────────────────────────────────
const DEFAULT_CHANNELS = [
    { name: "Akon", channelId: "UC6IBMCQ6-d7p41KHxOsq4RA", type: "artist" },
    { name: "Amy Winehouse", channelId: "UCWsQKPFHQdRMJZSAAzh1Qbg", type: "artist" },
    { name: "Andrea Bocelli", channelId: "UCb4JB8-ZAeceuR7EPCPOPzg", type: "artist" },
    { name: "Audioslave", channelId: "UCbJHfnWtshjo6zJg9Y8XzBw", type: "artist" },
    { name: "Beastie Boys", channelId: "UCpRUSBcRWUQZIj3_jWF19Dg", type: "artist" },
    { name: "Bee Gees", channelId: "UCD9sCcKXnFxMeuFoNayVxeQ", type: "artist" },
    { name: "Billy Idol", channelId: "UCZAfHkJj43Lir2Id3GiGCjQ", type: "artist" },
    { name: "Black Eyed Peas", channelId: "UCBFaOy1_APEXEyA6Gws_Y1g", type: "artist" },
    { name: "Bob Marley", channelId: "UCAlTDckOOQ2jREOvuCShGbw", type: "artist" },
    { name: "Bob Seger", channelId: "UComKJVf5rNLl_RfC_rbt7qg", type: "artist" },
    { name: "Bon Jovi", channelId: "UCkBwnm7GOfYHsacwUjriC-w", type: "artist" },
    { name: "Boyz II Men", channelId: "UCIP_rqrDBiovNIbHLve7vNA", type: "artist" },
    { name: "Carpenters", channelId: "UCocF7enWc-JXxVyZxDjvewA", type: "artist" },
    { name: "Cat Stevens", channelId: "UCo0pv-U5bTDLlfdROjmCCGg", type: "artist" },
    { name: "Chris Cornell", channelId: "UCf0pcytyiYVYy3UOs52nsQg", type: "artist" },
    { name: "Coldplay", channelId: "UCDPM_n1atn2ijUwHd0NNRQw", type: "artist" },
    { name: "Common", channelId: "UCBGDlQIq1hx5nSTIpWTsGAQ", type: "artist" },
    { name: "D'Angelo", channelId: "UCKCWQOVUfdlDYX2_238_AeQ", type: "artist" },
    { name: "Def Leppard", channelId: "UCZjBqZjGsmI5OAVsLSroaWQ", type: "artist" },
    { name: "DMX", channelId: "UCQcTmBevae2jDeFEZ6VEQPzw", type: "artist" },
    { name: "Donna Summer", channelId: "UC6dX999wO3gBsS1qzm4I-KA", type: "artist" },
    { name: "Drake", channelId: "UCByOQJjav0CUDwxCk-jVNRQ", type: "artist" },
    { name: "Ed Sheeran", channelId: "UC0C-w0YjGpqDXGB8IHb662A", type: "artist" },
    { name: "Elton John", channelId: "UCcd0tBtip8YzdTCUw3OVv_Q", type: "artist" },
    { name: "Elvis Costello", channelId: "UCntMV2RV-IrRzQ2v4obEJ5w", type: "artist" },
    { name: "Eminem", channelId: "UCfM3zsQsOnfWNUppiycmBuw", type: "artist" },
    { name: "Erykah Badu", channelId: "UCDOZs-fcPo0ab9mqUnyN4cw", type: "artist" },
    { name: "Fall Out Boy", channelId: "UC2qWxZHgnlwDvcmLqP23jrA", type: "artist" },
    { name: "Frank Sinatra", channelId: "UCJtvg6ZFwzdFdtcHBqetvwg", type: "artist" },
    { name: "Frank Zappa", channelId: "UCj-Qb2d6dJJJtNL4rgr3FNw", type: "artist" },
    { name: "Glen Campbell", channelId: "UCJXKFn_FtlA3eJ94Bp2dLlA", type: "artist" },
    { name: "Godsmack", channelId: "UCe9rl8k6yymUeVzzXfFGWwA", type: "artist" },
    { name: "Guns N' Roses", channelId: "UCIak6JLVOjqhStxrL1Lcytw", type: "artist" },
    { name: "Heart", channelId: "UCsFPCqkPsesPa8XxN1pJx-w", type: "artist" },
    { name: "Janet Jackson", channelId: "UCz8ZHx5wFQpXWywaL2uqevw", type: "artist" },
    { name: "Jeremih", channelId: "UCBYpEIgqByL9n0VBnEC5SLQ", type: "artist" },
    { name: "Jimmy Eat World", channelId: "UCFeCvEjX56ReS-O3QHdyjbA", type: "artist" },
    { name: "Jodeci", channelId: "UCfPNbHJKbjxV3L1z5RYeDTQ", type: "artist" },
    { name: "John Lennon", channelId: "UCYU4eunPInnHTNWfGvOgkbg", type: "artist" },
    { name: "John Mellencamp", channelId: "UCzYJCeitN60eTc9UZvvRDoA", type: "artist" },
    { name: "Johnny Cash", channelId: "UCLwdOhL6TKbmjRtZ8wIr-Bg", type: "artist" },
    { name: "Juvenile", channelId: "UCSXRhf5E93q5bjELatiwk_w", type: "artist" },
    { name: "Kenny Rogers", channelId: "UCKRlpS2Z3rHf8glxuGhblyQ", type: "artist" },
    { name: "Keyshia Cole", channelId: "UCznrMQtAIr5-isdho4YQoMA", type: "artist" },
    { name: "Kiss", channelId: "UCyOw2FDjfQOFQH7paKxNVvA", type: "artist" },
    { name: "Lenny Kravitz", channelId: "UCdIs5dRqgZ1IWOdLZimHL_w", type: "artist" },
    { name: "Lionel Richie", channelId: "UCM3iG_kXUM_9HHVIDI7vEtg", type: "artist" },
    { name: "Little Big Town", channelId: "UCTtphRK-UT2pm4oPNy3GeGQ", type: "artist" },
    { name: "LL Cool J", channelId: "UCDG8P-_qq4PuT0DtxzlQlsw", type: "artist" },
    { name: "Mariah Carey", channelId: "UCurpiDXSkcUbgdMwHNZkrCg", type: "artist" },
    { name: "Marvin Gaye", channelId: "UCV0Arhg2bZuyL6CutipMduw", type: "artist" },
    { name: "Mary J. Blige", channelId: "UCj5CgwX_iJEqJsqUJyYjg4A", type: "artist" },
    { name: "Neil Diamond", channelId: "UCtPHmTX4_qC_h5cerkmLThQ", type: "artist" },
    { name: "Nelly", channelId: "UCOnzS9RKEhSvfUCsFbSrJ_A", type: "artist" },
    { name: "Nelly Furtado", channelId: "UC5Y-gAeGpzgzu0ObzKnhPFA", type: "artist" },
    { name: "Nirvana", channelId: "UCFMZHIQMgBXTSxsr86Caazw", type: "artist" },
    { name: "OneRepublic", channelId: "UCi4EDAgjULwwNBHOg1aaCig", type: "artist" },
    { name: "Paul McCartney", channelId: "UCvGnJy9RnXX0kGSnDPKCZzQ", type: "artist" },
    { name: "Peggy Lee", channelId: "UCWfdzpDGBCOOWxWVR0fLVNw", type: "artist" },
    { name: "Peter Frampton", channelId: "UCm3xsc3Bx3PB3dhsllSLoXA", type: "artist" },
    { name: "Queens of the Stone Age", channelId: "UCAqa6dDmCH4XwipdfxoMo4Q", type: "artist" },
    { name: "Ringo Starr", channelId: "UCqESxycliXwDheOseXqmq8w", type: "artist" },
    { name: "Roger Hodgson", channelId: "UCiDWjCWCtmW41-I_xzOufIA", type: "artist" },
    { name: "Rush", channelId: "UC5C-Asy_myoWCkLEtZR72SA", type: "artist" },
    { name: "Sammy Davis Jr.", channelId: "UCQU-I6rhD2V48cI5_yKAFAw", type: "artist" },
    { name: "Shania Twain", channelId: "UCadSacAVwG-QH6tWzjrmjxA", type: "artist" },
    { name: "Smashing Pumpkins", channelId: "UCnGcjQlLO8x7jsfw3r6U9ww", type: "artist" },
    { name: "Sonic Youth", channelId: "UCOWV89Ww70Uw4Jr8Rmc1GBA", type: "artist" },
    { name: "Soundgarden", channelId: "UCHKSayVT2Ks-gQBXmMLGTag", type: "artist" },
    { name: "Spice Girls", channelId: "UCnGcCZ0hZT6WJxTUZJqtOMA", type: "artist" },
    { name: "Sting", channelId: "UCwERP8ZAI10RtZIAPsZQDDw", type: "artist" },
    { name: "Supertramp", channelId: "UColTsKEMf0kaZjkoOx7-Cww", type: "artist" },
    { name: "Taylor Swift", channelId: "UCqECaJ8Gagnn7YCbPEzWH6g", type: "artist" },
    { name: "The Beach Boys", channelId: "UCUxNZEOdVy77QiiSTHk8bug", type: "artist" },
    { name: "The Beatles", channelId: "UCc4K7bAqpdBP8jh1j9XZAww", type: "artist" },
    { name: "The Black Crowes", channelId: "UC4ioqobfqRk8yawnN81ac5w", type: "artist" },
    { name: "The Cranberries", channelId: "UCb0vzLwvr7xbJgdqMzejDhw", type: "artist" },
    { name: "The Game", channelId: "UC3eKKASjWY-WAGRII9iKHsQ", type: "artist" },
    { name: "The Rolling Stones", channelId: "UCB_Z6rBg3WW3NL4-QimhC2A", type: "artist" },
    { name: "The Who", channelId: "UCUtwj-3S97bj3lYDVxDKtlQ", type: "artist" },
    { name: "Toby Keith", channelId: "UCFGqp-AuKZQXAx95K8fPbAA", type: "artist" },
    { name: "Tom Petty", channelId: "UCvYomLPMwUr1FAXRMGhVfCQ", type: "artist" },
    { name: "Trisha Yearwood", channelId: "UCw0Nn2LTsXGB0rP53Z0ACWQ", type: "artist" },
    { name: "U2", channelId: "UC4gPNusMDwx2Xm-YI35AkCA", type: "artist" },
    { name: "Weezer", channelId: "UC7JDBUzkcwRGtQGia3_mMgQ", type: "artist" },
    // Omni channels
    { name: "Vevo", channelId: "UC2pmfLm7iq6Ov1UwYrWYkZA", type: "omni" },
];

// ─── Config ────────────────────────────────────────────────────
let PIPED_INSTANCES = [
    'pipedapi.kavin.rocks',
    'pipedapi.leptons.xyz',
    'pipedapi-libre.kavin.rocks',
    'piped-api.codespace.cz',
    'pipedapi.adminforge.de'
];
const ALLORIGINS_PROXY = 'https://api.allorigins.win/raw?url=';
const CORS_PROXIES = [
    'https://api.allorigins.win/raw?url=',
    'https://corsproxy.io/?',
    'https://api.codetabs.com/v1/proxy?quest=',
];
const DAYS_WINDOW = 6;
const CONCURRENCY = 8;
const RSS_CACHE_TTL = 10 * 60 * 1000; // 10 minute cache for RSS results
const MAX_CHANNELS = 200;

// ─── State ─────────────────────────────────────────────────────
let channels = [];
let allVideos = [];
let dismissed = [];
let workingInstance = null;
let currentTab = 'youtube';

// ─── Password Protection ──────────────────────────────────────
async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

const PW_HASH_KEY = 'yt_tracker_pw_hash';
const AUTH_KEY = 'yt_tracker_auth';

function getStoredHash() { return localStorage.getItem(PW_HASH_KEY); }

async function handlePassword() {
    const input = document.getElementById('pw-input').value;
    if (!input) return;
    const hash = await sha256(input);
    const stored = getStoredHash();
    if (!stored) {
        localStorage.setItem(PW_HASH_KEY, hash);
        sessionStorage.setItem(AUTH_KEY, 'true');
        showApp();
    } else if (hash === stored) {
        sessionStorage.setItem(AUTH_KEY, 'true');
        showApp();
    } else {
        document.getElementById('pw-error').textContent = 'Wrong password. Try again.';
        document.getElementById('pw-input').value = '';
        document.getElementById('pw-input').focus();
    }
}

function showApp() {
    document.getElementById('gate').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    init();
}

function showGate() {
    document.getElementById('gate').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    const stored = getStoredHash();
    if (!stored) {
        document.getElementById('gate-title').textContent = 'Priority Artist Hub';
        document.getElementById('gate-subtitle').textContent = 'Set a password to get started';
        document.getElementById('pw-btn').textContent = 'Set Password';
    } else {
        document.getElementById('gate-title').textContent = 'Priority Artist Hub';
        document.getElementById('gate-subtitle').textContent = 'Enter your password to continue';
        document.getElementById('pw-btn').textContent = 'Enter';
    }
}

function logout() {
    sessionStorage.removeItem(AUTH_KEY);
    document.getElementById('pw-input').value = '';
    document.getElementById('pw-error').textContent = '';
    showGate();
}

document.getElementById('pw-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') handlePassword();
});

// ─── Tab Navigation ─────────────────────────────────────────────
function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    document.getElementById(`content-${tab}`).classList.add('active');
}

// ─── Init ──────────────────────────────────────────────────────
async function init() {
    loadChannels();
    await loadDismissed();
    renderChannelPills();
    updateSubtitle();
    populateStoreButtons();
    discoverInstances(); // non-blocking, RSS is primary now
    // Don't auto-load tabs - user must click Refresh
    showInitialMessages();
}

function showInitialMessages() {
    // YouTube tab
    document.getElementById('feed').innerHTML = '<div class="no-data">Click <strong>Refresh</strong> to load videos.</div>';
    // Stores tab already shows individual store buttons
    // News tab
    document.getElementById('news-feed').innerHTML = '<div class="no-data">Click <strong>Refresh</strong> to load news.</div>';
}

// ─── Channel Management ────────────────────────────────────────
function loadChannels() {
    const stored = localStorage.getItem('yt_tracker_channels_v2');
    if (stored) {
        channels = JSON.parse(stored);
        // Merge any new defaults
        const existingIds = new Set(channels.map(c => c.channelId));
        let added = false;
        for (const def of DEFAULT_CHANNELS) {
            if (!existingIds.has(def.channelId)) {
                channels.push(def);
                added = true;
            }
        }
        if (added) {
            channels.sort((a, b) => a.name.localeCompare(b.name));
            saveChannels();
        }
    } else {
        // Migrate from old format
        const oldStored = localStorage.getItem('yt_tracker_artists');
        if (oldStored) {
            const oldChannels = JSON.parse(oldStored);
            channels = oldChannels.map(c => ({
                name: c.name,
                channelId: c.channelId,
                type: c.filter ? 'omni' : 'artist'
            }));
        } else {
            channels = [...DEFAULT_CHANNELS];
        }
        saveChannels();
    }
}

function saveChannels() {
    localStorage.setItem('yt_tracker_channels_v2', JSON.stringify(channels));
}

function getArtistNames() {
    return channels.filter(c => c.type === 'artist').map(c => c.name);
}

function addChannel(name, channelId, type) {
    if (channels.length >= MAX_CHANNELS) return;
    if (channels.some(c => c.channelId === channelId)) return;
    channels.push({ name, channelId, type });
    channels.sort((a, b) => a.name.localeCompare(b.name));
    saveChannels();
    renderChannelPills();
    updateSubtitle();
}

function removeChannel(channelId) {
    channels = channels.filter(c => c.channelId !== channelId);
    saveChannels();
    renderChannelPills();
    updateSubtitle();
    allVideos = allVideos.filter(v => v.channelId !== channelId);
    renderFeed();
}

function renderChannelPills() {
    const artistChannels = channels.filter(c => c.type === 'artist');
    const omniChannels = channels.filter(c => c.type === 'omni');

    document.getElementById('artist-count').textContent = artistChannels.length;
    document.getElementById('omni-count').textContent = omniChannels.length;

    document.getElementById('artist-pills').innerHTML = artistChannels.map(c =>
        `<span class="channel-pill">${esc(c.name)}<button class="remove-channel" onclick="event.stopPropagation();removeChannel('${c.channelId}')" title="Remove">&times;</button></span>`
    ).join('');

    document.getElementById('omni-pills').innerHTML = omniChannels.map(c =>
        `<span class="channel-pill omni">${esc(c.name)}<button class="remove-channel" onclick="event.stopPropagation();removeChannel('${c.channelId}')" title="Remove">&times;</button></span>`
    ).join('');
}

function updateSubtitle() {
    const artistCount = channels.filter(c => c.type === 'artist').length;
    const omniCount = channels.filter(c => c.type === 'omni').length;
    document.getElementById('subtitle').textContent =
        `${artistCount} YT artists, ${omniCount} omni`;
}

function toggleManage() {
    const section = document.getElementById('manage-section');
    const btn = document.getElementById('manage-toggle');
    const open = section.classList.toggle('open');
    btn.innerHTML = (open ? '&#9830;' : '&#9830;') + ' Manage Channels';
}


// ─── Channel Search ─────────────────────────────────────────────
async function searchChannel() {
    const q = document.getElementById('channel-search').value.trim();
    if (!q) return;
    const el = document.getElementById('search-results');
    el.innerHTML = '<div style="font-size:0.85rem;color:#666;padding:8px 0;">Searching...</div>';
    try {
        const data = await pipedFetch(`/search?q=${encodeURIComponent(q)}&filter=channels`);
        if (!data) {
            el.innerHTML = '<div style="font-size:0.85rem;color:#E31C25;padding:8px 0;">Search failed. Try again.</div>';
            return;
        }
        const items = (data.items || []).slice(0, 5);
        if (!items.length) {
            el.innerHTML = '<div style="font-size:0.85rem;color:#6a5a4a;padding:8px 0;font-style:italic;">No channels found.</div>';
            return;
        }
        el.innerHTML = items.map(ch => {
            const id = ch.url ? ch.url.replace('/channel/', '') : '';
            const subs = ch.subscribers >= 0 ? formatCount(ch.subscribers) + ' subscribers' : '';
            const thumb = ch.thumbnail || '';
            return `<div class="search-result">
                <img src="${esc(thumb)}" alt="" onerror="this.style.display='none'">
                <div class="sr-info">
                    <div class="sr-name">${esc(ch.name || '')}</div>
                    <div class="sr-subs">${esc(subs)}</div>
                </div>
                <button class="sr-add" onclick="event.stopPropagation();addChannelFromSearch('${esc(ch.name || '')}','${esc(id)}',this)">Add</button>
            </div>`;
        }).join('');
    } catch (e) {
        el.innerHTML = '<div style="font-size:0.85rem;color:#C75050;padding:8px 0;">Search failed. Try again.</div>';
    }
}

function addChannelFromSearch(name, channelId, btn) {
    if (!channelId) return;
    const type = document.getElementById('channel-type').value;
    addChannel(name, channelId, type);
    btn.textContent = 'Added';
    btn.disabled = true;
    btn.style.opacity = '0.5';
}

document.getElementById('channel-search').addEventListener('keydown', e => {
    if (e.key === 'Enter') searchChannel();
});

// ─── Dismissed Videos (Cloud-synced) ─────────────────────────
const DISMISSED_API = 'https://x5clvswqw7.execute-api.us-east-1.amazonaws.com/prod/dismissed?key=racine456';

async function loadDismissed() {
    // Load from localStorage cache first for instant display
    const cached = localStorage.getItem('yt_tracker_dismissed_ids');
    if (cached) {
        try { dismissed = JSON.parse(cached).map(id => ({ id, ts: 0 })); } catch {}
    }
    // Then sync from cloud
    try {
        const res = await fetch(DISMISSED_API);
        if (res.ok) {
            const ids = await res.json();
            dismissed = ids.map(id => ({ id, ts: 0 }));
            localStorage.setItem('yt_tracker_dismissed_ids', JSON.stringify(ids));
        }
    } catch {}
}

function saveDismissedToCloud(videoId, action) {
    fetch(DISMISSED_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ videoId, action })
    }).catch(() => {});
}

function dismissVideo(videoId) {
    if (!dismissed.some(d => d.id === videoId)) {
        dismissed.push({ id: videoId, ts: Date.now() });
        // Update local cache
        const ids = dismissed.map(d => d.id);
        localStorage.setItem('yt_tracker_dismissed_ids', JSON.stringify(ids));
        // Sync to cloud
        saveDismissedToCloud(videoId, 'dismiss');
    }
    const card = document.querySelector(`[data-video-id="${videoId}"]`);
    if (card) card.classList.add('dismissed');
    updateFeedCount();
}

function isDismissed(videoId) {
    return dismissed.some(d => d.id === videoId);
}

// ─── Piped API ─────────────────────────────────────────────────
async function discoverInstances() {
    // Use cached instances if less than 12 hours old
    try {
        const cached = localStorage.getItem('piped_instances_cache');
        const cacheTime = localStorage.getItem('piped_instances_cache_time');
        if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 12 * 60 * 60 * 1000) {
            PIPED_INSTANCES = JSON.parse(cached);
            return;
        }
    } catch {}

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const res = await fetch('https://piped-instances.kavin.rocks/', { signal: controller.signal });
        clearTimeout(timeoutId);
        if (res.ok) {
            const list = await res.json();
            const apis = list.filter(i => i.api_url).map(i => new URL(i.api_url).host);
            if (apis.length > 0) {
                PIPED_INSTANCES = apis;
                localStorage.setItem('piped_instances_cache', JSON.stringify(apis));
                localStorage.setItem('piped_instances_cache_time', Date.now().toString());
            }
        }
    } catch {}
}

async function pipedFetch(path) {
    const timeout = ms => new Promise((_, rej) => setTimeout(() => rej('timeout'), ms));

    // Restore cached working instance if we don't have one
    if (!workingInstance) {
        workingInstance = localStorage.getItem('piped_working_instance');
    }

    if (workingInstance) {
        try {
            const res = await Promise.race([fetch(`https://${workingInstance}${path}`), timeout(3000)]);
            if (res.ok) {
                const data = await res.json();
                if (data && data.relatedStreams) return data;
                throw new Error('bad response');
            }
        } catch {
            workingInstance = null;
            localStorage.removeItem('piped_working_instance');
        }
    }
    // Only try 3 instances max to avoid long waits
    for (const inst of PIPED_INSTANCES.slice(0, 3)) {
        try {
            const res = await Promise.race([fetch(`https://${inst}${path}`), timeout(3000)]);
            if (res.ok) {
                const data = await res.json();
                if (data && data.relatedStreams) {
                    workingInstance = inst;
                    localStorage.setItem('piped_working_instance', inst);
                    return data;
                }
            }
        } catch {}
    }
    return null;
}

async function fetchChannelVideos(channel) {
    // Try RSS first (direct YouTube feed, more reliable)
    const rssResult = await fetchRSS(channel);
    if (rssResult && rssResult.length > 0) return rssResult;

    // Fall back to Piped API if RSS fails
    const data = await pipedFetch(`/channel/${channel.channelId}`);
    if (data && data.relatedStreams) {
        return data.relatedStreams.map(v => ({
            videoId: v.url ? v.url.replace('/watch?v=', '') : '',
            title: v.title || '',
            channel: data.name || v.uploaderName || '',
            channelId: channel.channelId,
            channelType: channel.type,
            thumbnail: v.thumbnail || '',
            duration: v.duration || 0,
            uploaded: v.uploaded || 0,
            views: v.views || 0
        }));
    }
    return [];
}

async function fetchTextWithProxy(url, proxyUrl, timeoutMs = 5000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
        const res = await fetch(proxyUrl + encodeURIComponent(url), {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        // Validate it's actually XML, not an error page
        if (text.length < 100 || (!text.includes('<feed') && !text.includes('<rss'))) throw new Error('Not valid RSS');
        return text;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

function parseRSSXml(text, channel) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, 'text/xml');
    const entries = xml.querySelectorAll('entry');
    if (entries.length === 0) return null;
    const channelName = xml.querySelector('author > name')?.textContent || '';
    return Array.from(entries).map(entry => {
        const videoId = entry.querySelector('videoId')?.textContent || '';
        const title = entry.querySelector('title')?.textContent || '';
        const published = entry.querySelector('published')?.textContent || '';
        const thumb = entry.querySelector('group > thumbnail')?.getAttribute('url') || '';
        const views = parseInt(entry.querySelector('group > community > statistics')?.getAttribute('views') || '0');
        return {
            videoId, title, channel: channelName, channelId: channel.channelId,
            channelType: channel.type, thumbnail: thumb, duration: 0,
            uploaded: new Date(published).getTime(), views
        };
    });
}

function getRSSCache(channelId) {
    try {
        const cached = localStorage.getItem(`rss_cache_${channelId}`);
        if (!cached) return null;
        const { data, ts } = JSON.parse(cached);
        if (Date.now() - ts > RSS_CACHE_TTL) {
            localStorage.removeItem(`rss_cache_${channelId}`);
            return null;
        }
        return data;
    } catch { return null; }
}

function setRSSCache(channelId, data) {
    try {
        localStorage.setItem(`rss_cache_${channelId}`, JSON.stringify({ data, ts: Date.now() }));
    } catch {} // localStorage full, ignore
}

async function fetchRSS(channel) {
    // Check cache first
    const cached = getRSSCache(channel.channelId);
    if (cached) return cached;

    const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channel.channelId}`;

    // Race all proxies in parallel — first valid response wins
    try {
        const result = await new Promise((resolve, reject) => {
            let settled = false;
            let failures = 0;
            CORS_PROXIES.forEach(proxy => {
                fetchTextWithProxy(rssUrl, proxy, 5000)
                    .then(text => {
                        if (settled) return;
                        const parsed = parseRSSXml(text, channel);
                        if (parsed && parsed.length > 0) {
                            settled = true;
                            resolve(parsed);
                        } else {
                            throw new Error('Empty RSS');
                        }
                    })
                    .catch(() => {
                        failures++;
                        if (failures === CORS_PROXIES.length && !settled) {
                            settled = true;
                            resolve([]);
                        }
                    });
            });
        });
        if (result.length > 0) setRSSCache(channel.channelId, result);
        return result;
    } catch {
        return [];
    }
}

// ─── Lightbox ───────────────────────────────────────────────────
function openLightbox(maxresUrl, fallbackUrl) {
    const img = document.getElementById('lightbox-img');
    const lightbox = document.getElementById('lightbox');

    // Try maxres first, fallback to hq if it fails
    img.onerror = function() {
        img.onerror = null;
        img.src = fallbackUrl;
    };
    img.src = maxresUrl;
    lightbox.classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
    document.body.style.overflow = '';
}

// Close lightbox on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
});

// ─── Feed Loading ──────────────────────────────────────────────
let refreshInProgress = false;
async function refreshFeed() {
    if (refreshInProgress) return;
    refreshInProgress = true;
    try { await _refreshFeedInner(); } finally { refreshInProgress = false; }
}
async function _refreshFeedInner() {
    allVideos = [];
    const feedEl = document.getElementById('feed');
    feedEl.innerHTML = '<div class="feed-empty">Loading videos...</div>';

    const progressWrap = document.getElementById('progress-wrap');
    const progressBar = document.getElementById('progress-bar');
    progressWrap.style.display = 'block';
    progressBar.style.width = '0%';

    const cutoff = Date.now() - DAYS_WINDOW * 24 * 60 * 60 * 1000;
    const artistNames = getArtistNames();
    let completed = 0;
    const total = channels.length;

    const queue = [...channels];
    const results = [];

    async function worker() {
        while (queue.length > 0) {
            const channel = queue.shift();
            try {
                const videos = await fetchChannelVideos(channel);
                if (videos) {
                    const recent = videos.filter(v => {
                        if (v.uploaded <= cutoff) return false;
                        if (v.duration > 0 && v.duration <= 30) return false;
                        // For omni channels, only include videos mentioning an artist
                        if (channel.type === 'omni') {
                            const titleLower = v.title.toLowerCase();
                            const matchedArtist = artistNames.find(name =>
                                titleLower.includes(name.toLowerCase())
                            );
                            if (!matchedArtist) return false;
                            v.matchedArtist = matchedArtist;
                        }
                        return true;
                    });
                    results.push(...recent);
                }
            } catch {}
            completed++;
            progressBar.style.width = Math.round((completed / total) * 100) + '%';
        }
    }

    const workers = [];
    for (let i = 0; i < Math.min(CONCURRENCY, total); i++) {
        workers.push(worker());
    }
    await Promise.all(workers);

    allVideos = results;
    allVideos.sort((a, b) => b.uploaded - a.uploaded);

    progressWrap.style.display = 'none';
    renderFeed();
}

// ─── Feed Rendering ────────────────────────────────────────────
function renderFeed() {
    const feedEl = document.getElementById('feed');
    const visible = allVideos.filter(v => !isDismissed(v.videoId));
    updateFeedCount();

    if (!visible.length) {
        feedEl.innerHTML = `<div class="feed-empty">No new videos in the last ${DAYS_WINDOW} days.</div>`;
        return;
    }

    feedEl.innerHTML = visible.map(v => {
        const isOfficialMV = /official\s+(music\s+)?video/i.test(v.title);
        const isPopular = v.views >= 100000;
        const titleClass = 'vc-title' + (isOfficialMV ? ' official-mv' : '');
        const viewsClass = 'vc-views-inline' + (isPopular ? ' popular' : '');
        const isOmni = v.channelType === 'omni';
        const omniTag = isOmni ? `<span class="vc-omni-tag">Omni</span>` : '';
        const artistTag = v.matchedArtist ? `<span class="vc-artist-match">${esc(v.matchedArtist)}</span>` : '';
        // Get high-res thumbnail
        const maxresThumbnail = `https://img.youtube.com/vi/${v.videoId}/maxresdefault.jpg`;
        const hqThumbnail = `https://img.youtube.com/vi/${v.videoId}/hqdefault.jpg`;

        return `
        <div class="video-card" data-video-id="${esc(v.videoId)}">
            <div class="vc-check" onclick="dismissVideo('${esc(v.videoId)}')" title="Dismiss"></div>
            <div class="vc-body">
                <div class="vc-meta">
                    <span class="vc-channel">${esc(v.channel)}</span>
                    ${omniTag}
                    <span class="vc-time">${timeAgo(v.uploaded)}</span>
                </div>
                <div class="${titleClass}">${esc(v.title)}</div>
                <div class="vc-info-row">
                    <span class="vc-duration">${formatDuration(v.duration)}</span>
                    <span class="${viewsClass}">${formatCount(v.views)} views</span>
                    ${artistTag}
                </div>
            </div>
            <div class="vc-thumb-wrap">
                <img class="vc-thumb" src="${esc(v.thumbnail)}" alt="" loading="lazy" onerror="this.src='${hqThumbnail}'">
                <div class="vc-thumb-btns">
                    <button class="vc-thumb-btn" onclick="openLightbox('${maxresThumbnail}', '${hqThumbnail}')" title="Enlarge image">&#x1F50D;</button>
                    <button class="vc-thumb-btn yt-btn" onclick="window.open('https://www.youtube.com/watch?v=${esc(v.videoId)}','_blank')" title="Watch on YouTube">&#x25B6;</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function updateFeedCount() {
    const visible = allVideos.filter(v => !isDismissed(v.videoId));
    document.getElementById('feed-title').textContent =
        `The Reel (${visible.length} video${visible.length !== 1 ? 's' : ''})`;
}


// ─── Helpers ───────────────────────────────────────────────────
function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function timeAgo(ts) {
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days === 1) return 'yesterday';
    return days + 'd ago';
}

function formatDuration(seconds) {
    if (!seconds) return '\u2014';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    return `${m}:${String(s).padStart(2, '0')}`;
}

function formatCount(n) {
    if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return String(n);
}


// ─── Billions Club ─────────────────────────────────────────────
// ─── Official Artist Stores ────────────────────────────────────
const ARTIST_STORES = [
    { name: '2Pac', url: 'https://shop.2pac.com', handle: 'shop.2pac.com' },
    { name: 'ABBA', url: 'https://abba-official-store.myshopify.com', handle: 'abba-official-store.myshopify.com' },
    { name: 'Aerosmith', url: 'https://store.aerosmith.com', handle: 'store.aerosmith.com' },
    { name: 'Amy Winehouse', url: 'https://us-store.amywinehouse.com', handle: 'us-store.amywinehouse.com' },
    { name: 'Andrea Bocelli', url: 'https://shopandreabocelli.com', handle: 'shopandreabocelli.com' },
    { name: 'Beach Boys', url: 'https://shop.thebeachboys.com', handle: 'shop.thebeachboys.com' },
    { name: 'Beastie Boys', url: 'https://shopus.beastieboys.com', handle: 'shopus.beastieboys.com' },
    { name: 'Beatles', url: 'https://usastore.thebeatles.com', handle: 'usastore.thebeatles.com' },
    { name: 'Bee Gees', url: 'https://shop.beegees.com', handle: 'shop.beegees.com' },
    { name: 'Black Crowes', url: 'https://shop.theblackcrowes.com', handle: 'shop.theblackcrowes.com' },
    { name: 'Black Sabbath', url: 'https://blacksabbathapparelshop.com', handle: 'blacksabbathapparelshop.com' },
    { name: 'Bob Marley', url: 'https://shop.bobmarley.com', handle: 'shop.bobmarley.com' },
    { name: 'Cam Sugar', url: 'https://usa.camsugarmusic.com', handle: 'usa.camsugarmusic.com' },
    { name: 'Carpenters', url: 'https://shop.carpentersofficial.com', handle: 'shop.carpentersofficial.com' },
    { name: 'Cranberries', url: 'https://shopus.cranberries.com', handle: 'shopus.cranberries.com' },
    { name: 'Def Leppard', url: 'https://store.defleppard.com', handle: 'store.defleppard.com' },
    { name: 'Drowning Pool', url: 'https://shop.drowningpool.live', handle: 'shop.drowningpool.live' },
    { name: 'Elton John', url: 'https://us-store.eltonjohn.com', handle: 'us-store.eltonjohn.com' },
    { name: 'Elvis Costello', url: 'https://shop.elviscostello.com', handle: 'shop.elviscostello.com' },
    { name: 'Frank Zappa', url: 'https://store.zappa.com', handle: 'store.zappa.com' },
    { name: 'Glen Campbell', url: 'https://store.glencampbell.com', handle: 'store.glencampbell.com' },
    { name: 'Go-Go\'s', url: 'https://store.gogos.com', handle: 'store.gogos.com' },
    { name: 'Guns N\' Roses', url: 'https://gnrmerch.com', handle: 'gnrmerch.com' },
    { name: 'Janet Jackson', url: 'https://store.janetjackson.com', handle: 'store.janetjackson.com' },
    { name: 'John Lennon', url: 'https://store.johnlennon.com', handle: 'store.johnlennon.com' },
    { name: 'KISS', url: 'https://shopkissonline.com', handle: 'shopkissonline.com' },
    { name: 'Loreena McKennitt', url: 'https://shoploreenamckennitt.com', handle: 'shoploreenamckennitt.com' },
    { name: 'Neil Diamond', url: 'https://shop.neildiamond.com', handle: 'shop.neildiamond.com' },
    { name: 'Paul McCartney', url: 'https://shop.paulmccartney.com', handle: 'shop.paulmccartney.com' },
    { name: 'Poison', url: 'https://store.poisonofficial.com', handle: 'store.poisonofficial.com' },
    { name: 'Ringo Starr', url: 'https://store.ringostarr.com', handle: 'store.ringostarr.com' },
    { name: 'Rod Stewart', url: 'https://shop.rodstewart.com', handle: 'shop.rodstewart.com' },
    { name: 'Rolling Stones', url: 'https://therollingstonesshop.com', handle: 'therollingstonesshop.com' },
    { name: 'Scorpions', url: 'https://us.scorpions.shop', handle: 'us.scorpions.shop' },
    { name: 'Spice Girls', url: 'https://storeus.thespicegirls.com', handle: 'storeus.thespicegirls.com' },
    { name: 'Steve Miller Band', url: 'https://store.stevemillerband.com', handle: 'store.stevemillerband.com' },
    { name: 'Temptations', url: 'https://shop.temptationsofficial.com', handle: 'shop.temptationsofficial.com' },
    { name: 'The Who', url: 'https://shop.thewho.com', handle: 'shop.thewho.com' },
    { name: 'Velvet Underground', url: 'https://shop.velvetundergroundmusic.com', handle: 'shop.velvetundergroundmusic.com' },
    { name: 'XXXTentacion', url: 'https://shop.wakemewhenimfree.com', handle: 'shop.wakemewhenimfree.com' },
];

let storesData = {};
let allStoreProducts = [];

async function fetchWithProxy(url, proxyUrl, timeoutMs = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
        const res = await fetch(proxyUrl + encodeURIComponent(url), {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const text = await res.text();

        // Check if response looks like HTML (proxy error page)
        if (text.trim().startsWith('<') || text.trim().startsWith('<!')) {
            throw new Error('Received HTML instead of JSON');
        }

        // Check for common error messages
        if (text.includes('403 Forbidden') || text.includes('Request forbidden')) {
            throw new Error('Proxy returned 403 Forbidden');
        }

        let parsed = JSON.parse(text);

        // Handle allorigins /get endpoint which wraps content in {contents: "..."}
        if (parsed.contents && typeof parsed.contents === 'string') {
            parsed = JSON.parse(parsed.contents);
        }

        return parsed;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

async function fetchStoreProducts(store) {
    const productsUrl = `${store.url}/products.json?limit=250`;

    // Try each proxy until one works (with 20 second timeout)
    for (let i = 0; i < CORS_PROXIES.length; i++) {
        try {
            const data = await fetchWithProxy(productsUrl, CORS_PROXIES[i], 20000);

            // Validate response has products
            if (!data || !Array.isArray(data.products)) {
                throw new Error('Invalid response - no products array');
            }

            const products = data.products;

            return products.map(p => ({
                id: p.id,
                title: p.title,
                vendor: p.vendor || store.name,
                handle: p.handle,
                url: `${store.url}/products/${p.handle}`,
                image: p.images?.[0]?.src || '',
                productType: p.product_type || '',
                tags: p.tags || [],
                variants: p.variants || [],
                availableForSale: p.variants?.some(v => v.available) ?? true,
                price: p.variants?.[0]?.price || '',
                compareAtPrice: p.variants?.[0]?.compare_at_price || '',
                sku: p.variants?.[0]?.sku || '',
                barcode: p.variants?.[0]?.barcode || '',
                storeName: store.name,
                storeUrl: store.url,
                createdAt: p.created_at || '',
                updatedAt: p.updated_at || '',
            }));
        } catch (error) {
            console.warn(`Proxy ${i + 1} failed for ${store.name}:`, error.message);
            // Continue to next proxy
        }
    }

    console.error(`All proxies failed for ${store.name}`);
    return [];
}

async function refreshStores() {
    // This function is no longer used since we removed the "Scan All Stores" button
    // Individual store scanning is done via scanSingleStore()
}

function populateStoreButtons() {
    const grid = document.getElementById('store-buttons-grid');
    grid.innerHTML = ARTIST_STORES.map((store, index) => `
        <button class="store-btn-individual" id="store-btn-${index}" onclick="scanSingleStore(${index})">
            <span class="store-btn-name">${store.name}</span>
            <span class="store-btn-status">Click to scan</span>
        </button>
    `).join('');
}

async function scanSingleStore(index) {
    const store = ARTIST_STORES[index];
    const btn = document.getElementById(`store-btn-${index}`);
    const statusEl = btn.querySelector('.store-btn-status');

    // Update button state
    btn.disabled = true;
    btn.className = 'store-btn-individual scanning';
    statusEl.textContent = 'Scanning...';

    try {
        const products = await fetchStoreProducts(store);

        // If no products returned, treat as failure
        if (products.length === 0) {
            throw new Error('No products found');
        }

        // Update store data
        storesData[store.name] = {
            products,
            soldOut: products.filter(p => !p.availableForSale),
            total: products.length,
        };

        // Rebuild allStoreProducts from storesData
        allStoreProducts = [];
        for (const storeName in storesData) {
            allStoreProducts.push(...storesData[storeName].products);
        }

        // Update button state
        btn.className = 'store-btn-individual success';
        const soldOut = storesData[store.name].soldOut.length;
        statusEl.textContent = `${products.length} products${soldOut > 0 ? `, ${soldOut} sold out` : ''}`;

        // Update list
        renderSoldOutList();

    } catch (error) {
        btn.className = 'store-btn-individual error';
        statusEl.textContent = 'Failed - try again';
    }

    btn.disabled = false;
}

function updateStoreButtonStates() {
    ARTIST_STORES.forEach((store, index) => {
        const btn = document.getElementById(`store-btn-${index}`);
        if (!btn) return;

        const data = storesData[store.name];
        const statusEl = btn.querySelector('.store-btn-status');

        if (data && data.products.length > 0) {
            btn.className = 'store-btn-individual success';
            const soldOut = data.soldOut.length;
            statusEl.textContent = `${data.products.length} products${soldOut > 0 ? `, ${soldOut} sold out` : ''}`;
        }
    });
}

function renderStoresStats() {
    // Stats section was removed - just update badge if it exists
    const soldOutProducts = allStoreProducts.filter(p => !p.availableForSale);
    const badge = document.getElementById('stores-sold-out-count');
    if (badge) {
        if (soldOutProducts.length > 0) {
            badge.textContent = soldOutProducts.length;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Check if SKU looks like a UPC (12-14 digit number)
function getProductUPC(product) {
    const sku = product.sku || '';
    // UPCs are 12-14 digit numbers
    if (/^[0-9]{12,14}$/.test(sku)) {
        return sku;
    }
    return null;
}

// Classify product as Music or Merch based on type, title, and tags
function classifyProduct(product) {
    const musicKeywords = [
        'vinyl', 'lp', 'cd', 'cassette', 'album', 'record', 'box set', 'boxset',
        'deluxe edition', 'limited edition', 'picture disc', 'colored vinyl',
        '7"', '12"', '10"', 'single', 'ep', 'music', 'audio', 'soundtrack',
        'remaster', 'reissue', 'pressing', 'gatefold', 'slipmat'
    ];
    const merchKeywords = [
        't-shirt', 'tee', 'shirt', 'hoodie', 'sweatshirt', 'jacket', 'hat', 'cap',
        'beanie', 'poster', 'print', 'mug', 'cup', 'bag', 'tote', 'backpack',
        'keychain', 'pin', 'patch', 'sticker', 'flag', 'banner', 'blanket',
        'socks', 'shorts', 'pants', 'dress', 'skirt', 'sweater', 'jersey',
        'lanyard', 'wristband', 'necklace', 'bracelet', 'ring', 'earrings',
        'apparel', 'clothing', 'wear', 'accessory', 'accessories', 'merch',
        'collectible', 'figurine', 'plush', 'toy', 'game', 'puzzle', 'book',
        'calendar', 'ornament', 'magnet', 'coaster', 'bottle', 'flask'
    ];

    const searchText = [
        product.title || '',
        product.productType || '',
        ...(product.tags || [])
    ].join(' ').toLowerCase();

    // Check for music keywords
    for (const keyword of musicKeywords) {
        if (searchText.includes(keyword)) {
            return 'music';
        }
    }

    // Check for merch keywords
    for (const keyword of merchKeywords) {
        if (searchText.includes(keyword)) {
            return 'merch';
        }
    }

    // Default based on common product types
    const type = (product.productType || '').toLowerCase();
    if (type.includes('music') || type.includes('audio') || type.includes('vinyl') || type.includes('cd')) {
        return 'music';
    }

    // Default to merch if unknown
    return 'merch';
}

function renderSoldOutList() {
    const listEl = document.getElementById('stores-sold-out-list');

    // Group sold out products by store
    const storesWithSoldOut = ARTIST_STORES.filter(store =>
        storesData[store.name]?.soldOut?.length > 0
    );

    if (storesWithSoldOut.length === 0) {
        if (Object.keys(storesData).length === 0) {
            listEl.innerHTML = '<div class="no-data">Click on individual stores above to check for sold-out products.</div>';
        } else {
            listEl.innerHTML = '<div class="no-data">No sold-out products found across all stores!</div>';
        }
        return;
    }

    listEl.innerHTML = storesWithSoldOut.map(store => {
        const data = storesData[store.name];
        const soldOut = data.soldOut || [];

        // Sort by category: Music first, then Merch
        const sortedSoldOut = [...soldOut].sort((a, b) => {
            const catA = classifyProduct(a);
            const catB = classifyProduct(b);
            if (catA === catB) return 0;
            return catA === 'music' ? -1 : 1;
        });

        // Group products by category
        const musicProducts = sortedSoldOut.filter(p => classifyProduct(p) === 'music');
        const merchProducts = sortedSoldOut.filter(p => classifyProduct(p) === 'merch');

        const renderProducts = (products) => products.map(p => {
            const category = classifyProduct(p);
            const upc = getProductUPC(p);
            return `
            <div class="sold-out-item">
                ${p.image ? `<img class="sold-out-thumb" src="${esc(p.image)}" alt="" loading="lazy">` : '<div class="sold-out-thumb"></div>'}
                <div class="sold-out-info">
                    <div class="sold-out-title">${esc(p.title)}</div>
                    <div class="sold-out-vendor">${esc(p.productType || 'Product')}</div>
                    ${upc ? `<div class="sold-out-upc">UPC: ${esc(upc)}</div>` : ''}
                </div>
                <span class="product-type-badge ${category}">${category === 'music' ? 'Music' : 'Merch'}</span>
                <span class="sold-out-badge">Sold Out</span>
                <a href="${esc(p.url)}" target="_blank" rel="noopener" class="sold-out-link" title="View product">↗</a>
            </div>
            `;
        }).join('');

        return `
            <div class="store-section" id="store-${store.handle.replace(/\./g, '-')}" data-store-name="${esc(store.name)}" data-store-url="${esc(store.url)}">
                <div class="store-section-header">
                    <div class="store-section-title" onclick="toggleStoreSection('${store.handle.replace(/\./g, '-')}')">
                        <span>${esc(store.name)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="store-copy-buttons">
                            <button class="store-copy-btn" onclick="event.stopPropagation(); copyStoreProducts('${esc(store.name)}', 'all')" title="Copy all products">All</button>
                            ${musicProducts.length > 0 ? `<button class="store-copy-btn music-btn" onclick="event.stopPropagation(); copyStoreProducts('${esc(store.name)}', 'music')" title="Copy music only">Music</button>` : ''}
                            ${merchProducts.length > 0 ? `<button class="store-copy-btn merch-btn" onclick="event.stopPropagation(); copyStoreProducts('${esc(store.name)}', 'merch')" title="Copy merch only">Merch</button>` : ''}
                        </div>
                        <span class="store-section-count" onclick="toggleStoreSection('${store.handle.replace(/\./g, '-')}')">${soldOut.length} sold out</span>
                        <span class="chevron" onclick="toggleStoreSection('${store.handle.replace(/\./g, '-')}')">▼</span>
                    </div>
                </div>
                <div class="store-section-body">
                    ${musicProducts.length > 0 ? `
                        <div class="category-group-header music">Music (${musicProducts.length})</div>
                        ${renderProducts(musicProducts)}
                    ` : ''}
                    ${merchProducts.length > 0 ? `
                        <div class="category-group-header merch">Merch (${merchProducts.length})</div>
                        ${renderProducts(merchProducts)}
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function toggleStoreSection(handle) {
    const section = document.getElementById(`store-${handle}`);
    if (section) {
        section.classList.toggle('open');
    }
}

function copyStoreProducts(storeName, filter = 'all') {
    const store = ARTIST_STORES.find(s => s.name === storeName);
    const data = storesData[storeName];

    if (!store || !data || !data.soldOut || data.soldOut.length === 0) {
        alert('No products to copy for this store.');
        return;
    }

    // Filter products based on selection
    let products = [...data.soldOut];
    if (filter === 'music') {
        products = products.filter(p => classifyProduct(p) === 'music');
    } else if (filter === 'merch') {
        products = products.filter(p => classifyProduct(p) === 'merch');
    }

    if (products.length === 0) {
        alert(`No ${filter} products to copy.`);
        return;
    }

    // Sort products: Music first, then Merch (for 'all')
    if (filter === 'all') {
        products.sort((a, b) => {
            const catA = classifyProduct(a);
            const catB = classifyProduct(b);
            if (catA === catB) return 0;
            return catA === 'music' ? -1 : 1;
        });
    }

    // Build the text to copy
    let text = `${storeName}\n${store.url}\n\nIt looks like the following products are sold out.\n\n`;

    products.forEach(p => {
        text += `${p.title}\n`;
        text += `${p.url}\n`;
        const upc = getProductUPC(p);
        if (upc) {
            text += `UPC: ${upc}\n`;
        }
        text += '\n';
    });

    // Copy to clipboard
    navigator.clipboard.writeText(text.trim()).then(() => {
        // Find the clicked button by matching store name and filter
        const buttons = document.querySelectorAll('.store-copy-btn');
        buttons.forEach(btn => {
            const onclick = btn.getAttribute('onclick') || '';
            if (onclick.includes(`'${storeName}'`) && onclick.includes(`'${filter}'`)) {
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }
        });
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
    });
}

function downloadStoresCSV() {
    if (allStoreProducts.length === 0) {
        alert('No products to export. Please scan stores first.');
        return;
    }

    // Build CSV
    const headers = [
        'Store Name',
        'Product Title',
        'Category',
        'Vendor',
        'Product Type',
        'Handle',
        'URL',
        'Available',
        'Price',
        'Compare At Price',
        'SKU',
        'Barcode/UPC',
        'Tags',
        'Created At',
        'Updated At',
        'Image URL'
    ];

    const rows = allStoreProducts.map(p => [
        p.storeName,
        p.title,
        classifyProduct(p) === 'music' ? 'Music' : 'Merch',
        p.vendor,
        p.productType,
        p.handle,
        p.url,
        p.availableForSale ? 'Yes' : 'No',
        p.price,
        p.compareAtPrice,
        p.sku,
        p.barcode,
        Array.isArray(p.tags) ? p.tags.join('; ') : p.tags,
        p.createdAt,
        p.updatedAt,
        p.image
    ]);

    // Escape CSV values
    const escapeCSV = (val) => {
        if (val === null || val === undefined) return '';
        const str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    };

    const csv = [
        headers.join(','),
        ...rows.map(row => row.map(escapeCSV).join(','))
    ].join('\n');

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const timestamp = new Date().toISOString().slice(0, 10);
    link.download = `artist-stores-products-${timestamp}.csv`;
    link.click();
    URL.revokeObjectURL(url);
}


// ─── Music News ─────────────────────────────────────────────────
const NEWS_FEEDS = [
    { id: 'billboard', name: 'Billboard', url: 'https://www.billboard.com/feed/' },
    { id: 'variety', name: 'Variety', url: 'https://variety.com/v/music/feed/' },
    { id: 'rollingstone', name: 'Rolling Stone', url: 'https://www.rollingstone.com/music/feed/' },
];
const NEWS_CACHE_TTL = 15 * 60 * 1000; // 15 min cache
let newsArticles = [];
let newsFilter = 'all';
const TRACKED_ARTISTS = [
    'Aerosmith','Akon','Amy Winehouse','Andrea Bocelli','Audioslave','Beastie Boys',
    'Bee Gees','Billy Idol','Black Eyed Peas','Bob Marley','Bob Seger','Bon Jovi',
    'Boyz II Men','Cat Stevens','Yusuf Islam','Chris Cornell','Common','D\'Angelo',
    'Def Leppard','DMX','Elton John','Elvis Costello','Erykah Badu','Fall Out Boy',
    'Frank Sinatra','Frank Zappa','Glen Campbell','Godsmack','Guns N\' Roses',
    'Heart','Janet Jackson','Jeremih','Jimmy Eat World','Jodeci','John Lennon',
    'John Mellencamp','Johnny Cash','Juvenile','Kenny Rogers','Keyshia Cole','Kiss',
    'Lenny Kravitz','Lionel Richie','Little Big Town','LL COOL J','Mariah Carey',
    'Marvin Gaye','Mary J. Blige','Neil Diamond','Nelly Furtado','Nirvana',
    'OneRepublic','Paul McCartney','Peter Frampton','Queens Of The Stone Age',
    'Ringo Starr','Roger Hodgson','Rush','Shania Twain','Smashing Pumpkins',
    'Sonic Youth','Soundgarden','Spice Girls','Sting','Supertramp','The Beach Boys',
    'The Beatles','The Black Crowes','The Cranberries','The Game','The Rolling Stones',
    'The Who','Toby Keith','Tom Petty','Heartbreakers','Trisha Yearwood','U2','Weezer','Nelly'
];
const _artistRegex = new RegExp('\\b(' + TRACKED_ARTISTS.map(a => a.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')\\b', 'gi');
function matchArtists(text) {
    _artistRegex.lastIndex = 0;
    const found = new Set();
    let m;
    while ((m = _artistRegex.exec(text)) !== null) found.add(m[1]);
    return [...found];
}

async function fetchNewsFeed(feed) {
    const cacheKey = `news_cache_${feed.id}`;
    try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            const { data, ts } = JSON.parse(cached);
            if (Date.now() - ts < NEWS_CACHE_TTL) return data;
        }
    } catch {}

    const proxies = [...CORS_PROXIES];
    try {
        const result = await new Promise((resolve, reject) => {
            let settled = false;
            let failures = 0;
            proxies.forEach(proxy => {
                fetchTextWithProxy(feed.url, proxy, 8000)
                    .then(text => {
                        if (settled) return;
                        if (!text || !text.includes('<item>')) throw new Error('Invalid RSS');
                        settled = true;
                        resolve(text);
                    })
                    .catch(() => {
                        failures++;
                        if (failures === proxies.length && !settled) { settled = true; reject(new Error('All proxies failed')); }
                    });
            });
        });
        const articles = parseNewsRSS(result, feed);
        localStorage.setItem(cacheKey, JSON.stringify({ data: articles, ts: Date.now() }));
        return articles;
    } catch { return []; }
}

function parseNewsRSS(xml, feed) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, 'text/xml');
    const items = doc.querySelectorAll('item');
    const articles = [];
    items.forEach(item => {
        const title = item.querySelector('title')?.textContent?.trim() || '';
        const link = item.querySelector('link')?.textContent?.trim() || '';
        const pubDate = item.querySelector('pubDate')?.textContent?.trim() || '';
        const creator = item.querySelector('creator')?.textContent?.trim() || '';
        const desc = item.querySelector('description')?.textContent?.trim() || '';
        // Strip HTML tags from description
        const cleanDesc = desc.replace(/<[^>]*>/g, '').slice(0, 200);
        articles.push({
            title, link, pubDate, creator, description: cleanDesc,
            source: feed.id, sourceName: feed.name,
            date: new Date(pubDate)
        });
    });
    return articles;
}

async function refreshNews() {
    const feedEl = document.getElementById('news-feed');
    feedEl.innerHTML = '<div class="no-data">Loading news...</div>';
    const results = await Promise.all(NEWS_FEEDS.map(f => fetchNewsFeed(f)));
    newsArticles = results.flat().sort((a, b) => b.date - a.date);
    renderNews();
}

function renderNews() {
    const feedEl = document.getElementById('news-feed');
    const filtered = newsFilter === 'all' ? newsArticles
        : newsFilter === 'artists' ? newsArticles.filter(a => matchArtists(a.title + ' ' + a.description).length > 0)
        : newsArticles.filter(a => a.source === newsFilter);
    if (filtered.length === 0) {
        feedEl.innerHTML = '<div class="no-data">No articles found. Click <strong>Refresh</strong> to load news.</div>';
        return;
    }
    feedEl.innerHTML = filtered.map(a => {
        const ago = timeAgo(a.date);
        const artists = matchArtists(a.title + ' ' + a.description);
        const isHighlight = artists.length > 0;
        return `<a class="news-card${isHighlight ? ' news-highlight' : ''}" href="${a.link}" target="_blank" rel="noopener">
            <div class="news-card-body">
                <div class="news-card-title">${escapeHtml(a.title)}</div>
                <div style="font-size:0.82rem;color:#8aacba;margin-bottom:6px;line-height:1.4;">${escapeHtml(a.description)}</div>
                <div class="news-card-meta">
                    <span class="news-card-source news-source-${a.source}">${a.sourceName}</span>
                    ${artists.map(ar => `<span class="news-artist-tag">${escapeHtml(ar)}</span>`).join('')}
                    ${a.creator ? `<span>${escapeHtml(a.creator)}</span>` : ''}
                    <span>${ago}</span>
                </div>
            </div>
        </a>`;
    }).join('');
}

function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function timeAgo(date) {
    const diff = Date.now() - date.getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    const days = Math.floor(hrs / 24);
    return `${days}d ago`;
}

function filterNews(filter) {
    newsFilter = filter;
    document.querySelectorAll('.news-filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderNews();
}

// ─── Boot ──────────────────────────────────────────────────────
if (sessionStorage.getItem(AUTH_KEY) === 'true' && getStoredHash()) {
    showApp();
} else {
    showGate();
}
</script>
</body>
</html>
